---
import Layout from "../../layouts/Layout.astro";
import { getSupabaseServerClient } from "@/lib/supabase/server";

// Check authentication
const supabase = await getSupabaseServerClient(Astro.cookies);
const { data: { session } } = await supabase.auth.getSession();

if (!session) {
  return Astro.redirect('/login?redirect=/collections/new');
}

let error = "";
let success = false;

// Handle form submission
if (Astro.request.method === "POST") {
  const formData = await Astro.request.formData();
  const name = formData.get("name")?.toString() || "";
  const description = formData.get("description")?.toString() || "";

  if (!name) {
    error = "Collection name is required";
  } else {
    const { error: insertError } = await supabase
      .from("collections")
      .insert([
        {
          name,
          description,
          user_id: session.user.id,
        },
      ]);

    if (insertError) {
      error = insertError.message;
    } else {
      success = true;
      // If there's a redirect parameter, use it
      const redirect = Astro.url.searchParams.get("redirect");
      if (redirect) {
        return Astro.redirect(redirect);
      }
      // Otherwise redirect to dashboard
      return Astro.redirect("/");
    }
  }
}
---

<Layout title="Create New Collection">
  <div class="container mx-auto px-4 py-8 max-w-2xl">
    <div class="mb-8">
      <h1 class="text-3xl font-bold mb-2">Create New Collection</h1>
      <p class="text-muted-foreground">
        Create a new collection to organize your flashcards.
      </p>
    </div>

    <div class="bg-white rounded-lg shadow-md p-6 border">
      {error && (
        <div class="mb-4 p-4 bg-red-100 text-red-800 rounded-lg border border-red-300">
          {error}
        </div>
      )}

      {success && (
        <div class="mb-4 p-4 bg-green-100 text-green-800 rounded-lg border border-green-300">
          Collection created successfully!
        </div>
      )}

      <form method="POST" class="space-y-6">
        <div class="space-y-2">
          <label for="name" class="block text-sm font-medium">Collection Name</label>
          <input
            type="text"
            id="name"
            name="name"
            required
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-400 focus:border-transparent"
            placeholder="Enter collection name..."
          />
        </div>

        <div class="space-y-2">
          <label for="description" class="block text-sm font-medium">Description (optional)</label>
          <textarea
            id="description"
            name="description"
            rows="3"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-400 focus:border-transparent resize-y"
            placeholder="Enter collection description..."
          ></textarea>
        </div>

        <div class="flex gap-4">
          <button
            type="submit"
            class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-6 rounded-lg transition-colors"
          >
            Create Collection
          </button>
          <a
            href="/"
            class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-800 font-medium py-3 px-6 rounded-lg transition-colors text-center"
          >
            Cancel
          </a>
        </div>
      </form>
    </div>
  </div>
</Layout> 